<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<meta name="author" content="Graeme Rocher">
<title>GORM Developer Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article">
<div id="header">
<h1>GORM Developer Guide</h1>
<div class="details">
<span id="author" class="author">Graeme Rocher</span><br>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This documentation describes the GORM API mechanics and how a datastore implementation can be built to interface to any database providing a GORM API onto it. This documentation is mainly targeted at developers interested in creating implementations of GORM ontop of alternative datastores.</p>
</div>
<div class="paragraph">
<p>As of this writing the project has several implementations of GORM against a variety of different datastore implementations. Current implementations include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate 3,4 and 5</p>
</li>
<li>
<p>MongoDB</p>
</li>
<li>
<p>Redis</p>
</li>
<li>
<p>Neo4j</p>
</li>
<li>
<p>Cassandra</p>
</li>
<li>
<p>java.util.ConcurrentHashMap (the fastest datastore in the world)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The remainder of this document describes how the project is structured, how to build a project and how to implement a GORM provider.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gettingStarted">Getting Started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_checking_out_and_building">Checking out and Building</h3>
<div class="paragraph">
<p>The project is currently hosted on Github at [<a href="https://github.com/grails/grails-data-mapping" class="bare">https://github.com/grails/grails-data-mapping</a>].</p>
</div>
<div class="paragraph">
<p>You are free to fork the project from there or clone it anonymously using git:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">git clone git<span class="annotation">@github</span>.com:grails/grails-data-mapping.git
cd grails-data-mapping</code></pre>
</div>
</div>
<div class="paragraph">
<p>The project has a <a href="http://gradle.org">Gradle</a> build. You will need Intellij 15 or greater to work with the source code.</p>
</div>
<div class="paragraph">
<p>Use the Intellij 15 Gradle tooling to import the project.</p>
</div>
<div class="paragraph">
<p>To build the project you can run the <code>assemble</code> task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">.<span class="regexp"><span class="delimiter">/</span><span class="content">gradlew assemble</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To install the jar files for the various subprojects into your local Maven repository you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">.<span class="regexp"><span class="delimiter">/</span><span class="content">gradlew install</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To build all of the documentation run the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">.<span class="regexp"><span class="delimiter">/</span><span class="content">gradlew allDocs</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Documentation will produced in the <code>build/docs</code> directory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you experience PermGen errors when building documentation you may need to increase the JVM permgen inside GRADLE_OPTS
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_project_structure">Project Structure</h3>
<div class="paragraph">
<p>The project is essentially a multi-project Gradle build. There is a core API and then subprojects that implement that API. The core API subprojects include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>grails-datastore-core</code> - The core API, this provides core interfaces for implementing a GORM provider</p>
</li>
<li>
<p><code>grails-datastore-gorm</code> - The runtime meta-programming and AST transformation infrastructure behind GORM. Also provides end users APIs like <code>grails.gorm.CriteriaBuilder</code> and <code>grails.gorm.DetachedCriteria</code></p>
</li>
<li>
<p><code>grails-datastore-gorm-support</code> - Support classes for easing the writing of a GORM plugin for Grails</p>
</li>
<li>
<p><code>grails-datastore-gorm-tck</code> - The TCK that includes hundreds of Spock specifications that a GORM implementation will need to pass</p>
</li>
<li>
<p><code>grails-datastore-web</code> - Classes required to integrate GORM into a web tier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Beyond these core subprojects there are implementations for various datastores. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>grails-datastore-mongodb/grails-datastore-gorm-hibernate</code> - GORM for Hibernate</p>
</li>
<li>
<p><code>grails-datastore-mongodb/grails-datastore-gorm-mongo</code> - GORM for MongoDB project [<a href="http://grails.org/plugin/mongodb" class="bare">http://grails.org/plugin/mongodb</a>]</p>
</li>
<li>
<p><code>grails-datastore-neo4j</code> - GORM for Neo4j project [<a href="http://grails.org/plugin/neo4j" class="bare">http://grails.org/plugin/neo4j</a>]</p>
</li>
<li>
<p><code>grails-datastore-redis/grails-datastore-gorm-redis</code> - GORM for Redis project [<a href="http://grails.org/plugin/redis" class="bare">http://grails.org/plugin/redis</a>]</p>
</li>
<li>
<p><code>grails-datastore-cassandra/grails-datastore-gorm-cassandra</code> - GORM for Cassandra project [<a href="http://grails.org/plugin/cassandra" class="bare">http://grails.org/plugin/cassandra</a>]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The documentation for each implementation is kept in the documentation subprojects that start with <code>grails-documentation</code>. There are documentation projects for the core API, MongoDB, Neo4j, Redis, and Cassandra.</p>
</div>
<div class="paragraph">
<p>Finally the Grails 3 plugins that are used to distribute the GORM implementations to end users can be found in the <code>grails-plugins</code> directory and the <code>grails2-plugins</code> directory for Grails 2.x.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understandingApi">Understanding the GORM API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>The GORM Developer API is split into a low-level API that implementors need to implement for each individual datastore and then set of higher level APIs that enhance domain classes with things regular users see such as dynamic finders, criteria queries and so on.</p>
</div>
<div class="paragraph">
<p>The low-level API classes are found in the <code>grails-datastore-core</code> subproject, whilst the higher level APIs used to enhance domain classes are found in <code>grails-datastore-gorm</code>. In this section we will discuss the low-level API.</p>
</div>
</div>
<div class="sect2">
<h3 id="datastoreBasics">Datastore Basics</h3>

</div>
<div class="sect2">
<h3 id="_the_mappingcontext">The MappingContext</h3>
<div class="paragraph">
<p>The <code>org.grails.datastore.mapping.model.MappingContext</code> interface is used to obtain metadata about the classes that are configured for persistence. There are <code>org.grails.datastore.mapping.model.PersistentEntity</code> and <code>org.grails.datastore.mapping.model.PersistentProperty</code> interfaces that represent a class and its properties respectively. These can be obtained and introspected via the <code>MappingContext</code>.</p>
</div>
<div class="paragraph">
<p>There are various concrete implementations of the <code>MappingContext</code> interface such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DocumentMappingContext</code> - Used for document stores, subclassed by <code>MongoMappingContext</code></p>
</li>
<li>
<p><code>JpaMappingContext</code> - Used for JPA</p>
</li>
<li>
<p><code>KeyValueMappingContext</code> - Used by key/value stores</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Creating a new <code>MappingContext</code> may be useful because it allows users to configure how a class is mapped to the underlying datastore using GORM&#8217;s <code>mapping</code> block as well as allowing registration of custom type converters and so on. The implementation for Neo4j looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Neo4jMappingContext</span> <span class="directive">extends</span> AbstractMappingContext {

    MappingFactory&lt;<span class="predefined-type">Collection</span>, <span class="predefined-type">Attribute</span>&gt; mappingFactory
    MappingConfigurationStrategy syntaxStrategy

    Neo4jMappingContext() {
        mappingFactory = <span class="keyword">new</span> GraphGormMappingFactory()
        syntaxStrategy = <span class="keyword">new</span> GormMappingConfigurationStrategy(mappingFactory)
        <span class="comment">//addTypeConverter(new StringToNumberConverterFactory().getConverter(BigDecimal))</span>
        addTypeConverter(<span class="keyword">new</span> StringToShortConverter())
        addTypeConverter(<span class="keyword">new</span> StringToBigIntegerConverter())
         ...
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> PersistentEntity createPersistentEntity(<span class="predefined-type">Class</span> javaClass) {
        GraphPersistentEntity persistentEntity = <span class="keyword">new</span> GraphPersistentEntity(javaClass, <span class="local-variable">this</span>)
        mappingFactory.createMappedForm(persistentEntity) <span class="comment">// populates mappingFactory.entityToPropertyMap as a side effect</span>
        persistentEntity
    }

    MappingConfigurationStrategy getMappingSyntaxStrategy() {
        syntaxStrategy
    }

    MappingFactory getMappingFactory() {
        mappingFactory
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how Neo4j provides a custom <code>GraphGormMappingFactory</code> and <code>GraphPersistentEntity</code> to allow the domain class configuration to be changed for a given Neo4j <code>Node</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_datastore_interface">The Datastore Interface</h3>
<div class="paragraph">
<p>The <code>org.grails.datastore.mapping.core.Datastore</code> interface is the equivalent of a SQL <code>DataSource</code> where by it provides the necessary capability to create a connection. In most cases one can simply subclass the <code>AbstractDatastore</code> super class and implement the <code>createSession</code> method. The following implementation is from the <code>SimpleMapDatastore</code> which implements GORM ontop of a <code>ConcurrentHashMap</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Override</span>
<span class="directive">protected</span> Session createSession(PropertyResolver connDetails) {
    <span class="keyword">return</span> <span class="keyword">new</span> SimpleMapSession(<span class="local-variable">this</span>, getMappingContext(), getApplicationEventPublisher());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation depends a lot on the underlying datastore. For example for MongoDB the following implementation is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Override</span>
<span class="directive">protected</span> Session createSession(PropertyResolver connDetails) {
    <span class="keyword">return</span> <span class="keyword">new</span> MongoSession(<span class="local-variable">this</span>, getMappingContext(), getApplicationEventPublisher(), <span class="predefined-constant">false</span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the <code>Datastore</code> also has a reference to the <code>MappingContext</code> discussed in the previous section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_session_interface">The Session Interface</h3>
<div class="paragraph">
<p>The <code>org.grails.datastore.mapping.core.Session</code> interface represents an active connection. It can be either stateful or stateless, depending on the implementation. For example of embedded databases where there is no network connection, a stateful session is not particularly useful, but a datastore that creates network connections you may want to cache returned instances to reduce load.</p>
</div>
<div class="paragraph">
<p>The <code>AbstractSession</code> class provides some support for creating stateful sessions, if you prefer a stateless implementation then simply implement <code>Session</code> or subclass <code>AbstractAttributeStoringSession</code>.</p>
</div>
<div class="paragraph">
<p>In general if you subclass <code>AbstractSession</code> the minimum you need to do is implement the <code>createPersister</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">protected</span> Persister createPersister(<span class="predefined-type">Class</span> cls, MappingContext mappingContext) {
    PersistentEntity entity = mappingContext.getPersistentEntity(cls.getName());
    <span class="keyword">if</span> (entity == <span class="predefined-constant">null</span>) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
    <span class="keyword">return</span> <span class="keyword">new</span> SimpleMapEntityPersister(mappingContext, entity, <span class="local-variable">this</span>,
        (SimpleMapDatastore) getDatastore(), publisher);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above is from the <code>SimpleMapSession</code> implementation, which creates a <code>SimpleMapEntityPersister</code> instance and returns it. Returning null indicates that the class cannot be persisted and an exception will be thrown</p>
</div>
</div>
<div class="sect2">
<h3 id="implementingCrud">Implementing CRUD</h3>
<div class="sect3">
<h4 id="_the_entitypersister_interface">The EntityPersister Interface</h4>
<div class="paragraph">
<p>The <code>EntityPersister</code> interface is used to implement the basic Create, Read, Update and Delete (CRUD) operations. There are individual methods to implement such as <code>persistEntity</code>, <code>updateEntity</code>, <code>deleteEntity</code> and so on.</p>
</div>
<div class="paragraph">
<p>In many cases there is a representation of an entity in its "native" form as supplied by the datastore driver. For example in Cassandra this could be a <code>ColumnFamily</code>, or in MongoDB a <code>DBCollection</code>.</p>
</div>
<div class="paragraph">
<p>To support implementation such cases there is an abstract <code>NativeEntryEntityPersister&lt;T, K&gt;</code> super class that provides the basis for an implementation that maps a native entry, such as a MongoDB <code>DBObject</code> or a Neo4j <code>Node</code> to a persist entity and back again.</p>
</div>
<div class="paragraph">
<p>The 2 generic types of this superclass indicate the native entry type (example <code>DBObject</code> in MongoDB) and the native key type (example <code>ObjectId</code> in MongoDB). The MongoDB implementation looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">public</span> <span class="type">class</span> <span class="class">MongoEntityPersister</span> <span class="directive">extends</span> NativeEntryEntityPersister&lt;DBObject, <span class="predefined-type">Object</span>&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>Object</code> is used for the key since MongoDB also supports Long and String-based identifiers.</p>
</div>
<div class="paragraph">
<p>They key methods that need implementing are defined below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getEntityFamily()</code> - Defines the the name of the entity group or family. This could be a database table, a Cassandra Column Family or a MongoDB collection.</p>
</li>
<li>
<p><code>T createNewEntry(String family)</code> - Creates a native entry ready to be inserted</p>
</li>
<li>
<p><code>Object getEntryValue(T nativeEntry, String property)</code> - Retrieves a value of entry and returns its Java object form. For example a "date" property stored as a String in the datastore would need to b returned as a java.util.Date at this point</p>
</li>
<li>
<p><code>setEntryValue(T nativeEntry, String key, Object value)</code> - Sets a value of the native entry, converting any Java objects to the required native format</p>
</li>
<li>
<p><code>deleteEntry(String family, K key, Object entry)</code> - Deletes an entry for the given family, native key and entry</p>
</li>
<li>
<p><code>T retrieveEntry(PersistentEntity persistentEntity, String family, Serializable key)</code> - Retrieves a native entry for the given entity, family and key</p>
</li>
<li>
<p><code>K storeEntry(PersistentEntity persistentEntity, EntityAccess entityAccess, K storeId, T nativeEntry)</code> - Stores a native entry for the given id</p>
</li>
<li>
<p><code>updateEntry(PersistentEntity persistentEntity, EntityAccess entityAccess, K key, T entry)</code> - Updates an entry</p>
</li>
<li>
<p><code>K generateIdentifier(PersistentEntity persistentEntity, T entry)</code> - Generate an identifier for the given native entry</p>
</li>
<li>
<p><code>PropertyValueIndexer getPropertyIndexer(PersistentProperty property)</code> - If the datastore requires manual indexing you&#8217;ll need to implement a <code>PropertyIndexer</code> otherwise return null</p>
</li>
<li>
<p><code>AssociationIndexer getAssociationIndexer(T nativeEntry, Association association)</code> - If the datastore requires manual indexing you&#8217;ll need to implement a <code>AssociationIndexer</code> otherwise return null</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_create">Create</h4>
<div class="paragraph">
<p>The <code>createNewEntry</code> method is used to create a native record that will be inserted into the datastore. In MongoDB this is a <code>DBObject</code> whilst in the implementation for <code>ConcurrentHashMap</code> it is another <code>Map</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Override</span>
<span class="directive">protected</span> DBObject createNewEntry(<span class="predefined-type">String</span> family) {
    <span class="keyword">return</span> <span class="keyword">new</span> BasicDBObject();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_read">Read</h4>
<div class="paragraph">
<p>The <code>retrieveEntry</code> method is used to retrieve a native record for a given key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">protected</span> DBObject retrieveEntry(<span class="directive">final</span> PersistentEntity persistentEntity,
        <span class="predefined-type">String</span> family, <span class="directive">final</span> <span class="predefined-type">Serializable</span> key) {
    <span class="keyword">return</span> mongoTemplate.execute(<span class="keyword">new</span> DbCallback&lt;DBObject&gt;() {
        <span class="directive">public</span> DBObject doInDB(DB con) <span class="directive">throws</span> MongoException, DataAccessException {
            DBCollection dbCollection = con.getCollection(getCollectionName(persistentEntity));
            <span class="keyword">return</span> dbCollection.findOne(key);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you can see the <code>MongoDB</code> implementation that uses a Spring Data <code>MongoTemplate</code> to find a <code>DBObject</code> for the given key. There is a separate <code>storeEntry</code> method that is used to actually store the native object. In <code>MongoDB</code> this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Override</span>
<span class="directive">protected</span> <span class="predefined-type">Object</span> storeEntry(<span class="directive">final</span> PersistentEntity persistentEntity, <span class="directive">final</span> EntityAccess entityAccess,
                            <span class="directive">final</span> <span class="predefined-type">Object</span> storeId, <span class="directive">final</span> DBObject nativeEntry) {
    <span class="keyword">return</span> mongoTemplate.execute(<span class="keyword">new</span> DbCallback&lt;<span class="predefined-type">Object</span>&gt;() {
        <span class="directive">public</span> <span class="predefined-type">Object</span> doInDB(DB con) <span class="directive">throws</span> MongoException, DataAccessException {
            nativeEntry.put(MONGO_ID_FIELD, storeId);
            <span class="keyword">return</span> storeId;
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice it doesn&#8217;t actually do anything native insert into a MongoDB collection. This is because the Datastore API supports the notion of batch insert operations and flushing. In the case of <code>MongoDB</code> the <code>MongoSession</code> implementation overrides the <code>flushPendingInserts</code> method of <code>AbstractSession</code> and performs a batch insert of multiple MongoDB documents (ie `DBObject`s) at once:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">collection.insert(dbObjects.toArray(<span class="keyword">new</span> DBObject[dbObjects.size()]), writeConcernToUse);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other datastores that  do not support batch inserts would instead to the insert in the <code>storeEntry</code> method itself. For example the implementation for <code>ConcurrentHashMap</code> looks like (note Groovy code):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">protected</span> storeEntry(PersistentEntity persistentEntity, EntityAccess entityAccess, storeId, <span class="predefined-type">Map</span> nativeEntry) {
    <span class="keyword">if</span> (!persistentEntity.root) {
        nativeEntry.discriminator = persistentEntity.discriminator
    }
    datastore&lt;&lt;family&gt;&gt;.put(storeId, nativeEntry)
    <span class="keyword">return</span> storeId
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update">Update</h4>
<div class="paragraph">
<p>The <code>updateEntry</code> method is used to update an entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">public</span> <span class="type">void</span> updateEntry(<span class="directive">final</span> PersistentEntity persistentEntity, <span class="directive">final</span> EntityAccess ea,
        <span class="directive">final</span> <span class="predefined-type">Object</span> key, <span class="directive">final</span> DBObject entry) {
    mongoTemplate.execute(<span class="keyword">new</span> DbCallback&lt;<span class="predefined-type">Object</span>&gt;() {
        <span class="directive">public</span> <span class="predefined-type">Object</span> doInDB(DB con) <span class="directive">throws</span> MongoException, DataAccessException {
            <span class="predefined-type">String</span> collectionName = getCollectionName(persistentEntity, entry);
            DBCollection dbCollection = con.getCollection(collectionName);
            <span class="keyword">if</span> (isVersioned(ea)) {
                <span class="comment">// TODO this should be done with a CAS approach if possible</span>
                DBObject previous = dbCollection.findOne(key);
                checkVersion(ea, previous, persistentEntity, key);
            }

            MongoSession mongoSession = (MongoSession) session;
            dbCollection.update(dbo, entry, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, mongoSession.getWriteConcern());
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see again the underlying database specific <code>update</code> method is used, in this case the <code>DBCollection&#8217;s `update</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_delete">Delete</h4>
<div class="paragraph">
<p>The <code>deleteEntry</code> method is used to delete an entry. For example in the <code>ConcurrentHashMap</code> implementation it is simply removed from the map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">protected</span> <span class="type">void</span> deleteEntry(<span class="predefined-type">String</span> family, key, entry) {
    datastore&lt;&lt;family&gt;&gt;.remove(key)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst in <code>MongoDB</code> the <code>DBCollection</code> object&#8217;s <code>remove</code> method is called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Override</span>
<span class="directive">protected</span> <span class="type">void</span> deleteEntry(<span class="predefined-type">String</span> family, <span class="directive">final</span> <span class="predefined-type">Object</span> key, <span class="directive">final</span> <span class="predefined-type">Object</span> entry) {
    mongoTemplate.execute(<span class="keyword">new</span> DbCallback&lt;<span class="predefined-type">Object</span>&gt;() {
        <span class="directive">public</span> <span class="predefined-type">Object</span> doInDB(DB con) <span class="directive">throws</span> MongoException, DataAccessException {
            DBCollection dbCollection = getCollection(con);

            MongoSession mongoSession = (MongoSession) session;
            dbCollection.remove(key, mongoSession.getWriteConcern());
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }

        <span class="directive">protected</span> DBCollection getCollection(DB con) {
            <span class="keyword">return</span> con.getCollection(getCollectionName(getPersistentEntity()));
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if the underlying datastore supports batch delete operations you may want override and implement the <code>deleteEntries</code> method which allows for deleting multiple entries in a single operation. The implementation for MongoDB looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">protected</span> <span class="type">void</span> deleteEntries(<span class="predefined-type">String</span> family, <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; keys) {
    mongoTemplate.execute(<span class="keyword">new</span> DbCallback&lt;<span class="predefined-type">Object</span>&gt;() {
        <span class="directive">public</span> <span class="predefined-type">Object</span> doInDB(DB con) <span class="directive">throws</span> MongoException, DataAccessException {
            <span class="predefined-type">String</span> collectionName = getCollectionName(getPersistentEntity());
            DBCollection dbCollection = con.getCollection(collectionName);

            MongoSession mongoSession = (MongoSession) getSession();
            MongoQuery query = mongoSession.createQuery(getPersistentEntity().getJavaClass());
            query.in(getPersistentEntity().getIdentity().getName(), keys);

            dbCollection.remove(query.getMongoQuery());

            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice this implementation uses a <code>MongoQuery</code> instance. Note that implementing an <code>EntityPersister</code> you have enabled basic CRUD operations, but not querying, which is a topic of the following sections. First, however secondary indices need to covered since they are required for querying.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="secondaryIndexes">Secondary Indexing</h3>
<div class="paragraph">
<p>Many datastores do not support secondary indexing or require you to build your own. In cases like this you will need to implement a <code>PropertyIndexer</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the underlying datastore supports secondary indexes then it is ok to just return a <code>null</code> PropertyIndexer and let the datastore handle the indexing
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example the <code>ConcurrentHashMap</code> implementation creates secondary indices by populating another <code>Map</code> containing the indices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">void</span> index(value, primaryKey) {

    <span class="keyword">def</span> index = getIndexName(value)
    <span class="keyword">def</span> indexed = indices&lt;&lt;index&gt;&gt;
    <span class="keyword">if</span> (indexed == <span class="predefined-constant">null</span>) {
        indexed = <span class="type">[]</span>
        indices&lt;&lt;index&gt;&gt; = indexed
    }
    <span class="keyword">if</span> (!indexed.contains(primaryKey)) {
        indexed &lt;&lt; primaryKey
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation for Redis is very similar and stores the primary key in a Redis set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">public</span> <span class="type">void</span> index(<span class="directive">final</span> <span class="predefined-type">Object</span> value, <span class="directive">final</span> <span class="predefined-type">Long</span> primaryKey) {
      <span class="keyword">if</span> (value == <span class="predefined-constant">null</span>) {
          <span class="keyword">return</span>;
      }
      <span class="directive">final</span> <span class="predefined-type">String</span> primaryIndex = createRedisKey(value);
      redisTemplate.sadd(primaryIndex, primaryKey);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An index name is typically built from the entity name, property name and property value. The primary key of the entity is stored in this index for later querying. In fact there is a <code>query</code> method that needs to be implemented on <code>PropertyIndexer</code>. The <code>ConcurrentHashMap</code> implementation looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">List</span> query(value, <span class="type">int</span> offset, <span class="type">int</span> max) {
    <span class="keyword">def</span> index = getIndexName(value)

    <span class="keyword">def</span> indexed = indices&lt;&lt;index&gt;&gt;
    <span class="keyword">if</span> (!indexed) {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.emptyList()
    }
    <span class="keyword">return</span> indexed[offset..max]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the characteristics of the underlying database you may want to do the indexing asynchronously or you may want to index into a search library such as Lucene. For datastores that are eventually consistent for example it makes sense to do all indexing asynchronously.</p>
</div>
<div class="paragraph">
<p>Finally, when an object is deleted it will need to removed from the indices. This can be done with the <code>deindex</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">void</span> deindex(value, primaryKey) {
    <span class="keyword">def</span> index = getIndexName(value)
    <span class="keyword">def</span> indexed = indices&lt;&lt;index&gt;&gt;
    <span class="keyword">if</span> (indexed) {
        indexed.remove(primaryKey)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementingQueries">Implementing Querying</h3>

</div>
<div class="sect2">
<h3 id="_introduction_2">Introduction</h3>
<div class="paragraph">
<p>The <code>org.grails.datastore.mapping.query.Query</code> abstract class defines the query model and it is the job of the GORM implementor to translate this query model into an underlying database query. This is different depending on the implementation and may involve:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generating a String-based query such as SQL or JPA-QL</p>
</li>
<li>
<p>Creating a query object such as MongoDB&#8217;s use of a <code>Document</code> to define queries</p>
</li>
<li>
<p>Generating for use with manually created Secondary indices as is the case with Redis</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Query</code> object defines the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One or many <code>Criterion</code> that define the criteria to query by.</p>
</li>
<li>
<p>Zero or many <code>Projection</code> instances that define what the data you want back will look like.</p>
</li>
<li>
<p>Pagination parameters such as <code>max</code>, <code>offset</code></p>
</li>
<li>
<p>Sorting parameters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many types of <code>Criterion</code> for each specific type of query, examples include <code>Equals</code>, <code>Between</code>, <code>Like</code> etc. Depending on the capabilities of the underlying datastore you may implement only a few of these.</p>
</div>
<div class="paragraph">
<p>There are also many types of <code>Projection</code> such as <code>SumProjection</code>, <code>MaxProjection</code> and <code>CountProjection</code>. Again you may implement only a few of these.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the underlying datastore doesn&#8217;t for example support calculating a <code>sum</code> or <code>max</code> of a particular property, there is a <code>ManualProjections</code> class that you can use to perform these operations in memory on the client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Writing a <code>Query</code> implementation is probably the most complex part of implementing a GORM provider, but starts by subclassing the <code>Query</code> class and implementing the <code>executeQuery</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">public</span> <span class="type">class</span> <span class="class">MongoQuery</span> <span class="directive">extends</span> <span class="predefined-type">Query</span> <span class="directive">implements</span> QueryArgumentsAware {
     ...

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_query_model">Using the Query Model</h3>
<div class="paragraph">
<p>To implement querying you need to understand the Query model. As discussed a <code>Query</code> contains a list of <code>Criterion</code>, however the root <code>Criterion</code> could be a conjunction (an AND query) or a disjunction (an OR query). The <code>Query</code> may also contain a combination of regular criterion (=, !=, LIKE etc.) and junctions (AND, OR or NOT). Implementing a <code>Query</code> therefore requires writing a recursive method. The implementation for <code>ConcurrentHashMap</code> looks like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Collection</span> executeSubQueryInternal(criteria, criteriaList) {
    SimpleMapResultList resultList = <span class="keyword">new</span> SimpleMapResultList(<span class="local-variable">this</span>)
    <span class="keyword">for</span> (<span class="predefined-type">Query</span>.Criterion criterion <span class="keyword">in</span> criteriaList) {
        <span class="keyword">if</span> (criterion <span class="keyword">instanceof</span> <span class="predefined-type">Query</span>.Junction) {
            resultList.results &lt;&lt; executeSubQueryInternal(criterion, criterion.criteria)
        }
        <span class="keyword">else</span> {
            PersistentProperty property = getValidProperty(criterion)
            <span class="keyword">def</span> handler = handlers[criterion.getClass()]

            <span class="keyword">def</span> results = handler?.call(criterion, property) ?: <span class="type">[]</span>
            resultList.results &lt;&lt; results
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that if a <code>Junction</code> is encountered (which represents an AND, OR or NOT) then the method recurses to handle the junctions, otherwise a handler for the <code>Criterion</code> class is obtained and executed. The <code>handlers</code> map is a map of <code>Criterion</code> class to query handlers. The implementation for <code>Equals</code> looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> handlers = [
    ...
    (<span class="predefined-type">Query</span>.Equals): { <span class="predefined-type">Query</span>.Equals equals, PersistentProperty property-&gt;
        <span class="keyword">def</span> indexer = entityPersister.getPropertyIndexer(property)
        <span class="directive">final</span> value = subqueryIfNecessary(equals)
        <span class="keyword">return</span> indexer.query(value)
    }
    ...
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which simply uses the property indexer to query for all identifiers. Of course here we are a describing a case of a datastore (in this case <code>ConcurrentHashMap</code>) which doesn&#8217;t support secondary indices. It may be that instead of manually querying the secondary indices in this way that you simply build a String-based or native query. For example in MongoDB this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">queryHandlers.put(Equals.class, <span class="keyword">new</span> QueryHandler&lt;Equals&gt;() {
    <span class="directive">public</span> <span class="type">void</span> handle(PersistentEntity entity, Equals criterion, <span class="predefined-type">Document</span> query) {
        <span class="predefined-type">String</span> propertyName = getPropertyName(entity, criterion);
        <span class="predefined-type">Object</span> value = criterion.getValue();
        PersistentProperty property = entity.getPropertyByName(criterion.getProperty());
        MongoEntityPersister.setDBObjectValue(query, propertyName, value, entity.getMappingContext());
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the query in this case is a <code>DBObject</code>. For Gemfire again the implementation is different:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">queryHandlers.put(Equals.class, <span class="keyword">new</span> QueryHandler() {
    <span class="directive">public</span> <span class="type">int</span> handle(PersistentEntity entity, Criterion criterion, <span class="predefined-type">StringBuilder</span> q, <span class="predefined-type">List</span> params, <span class="type">int</span> index) {
        Equals eq = (Equals) criterion;
        <span class="directive">final</span> <span class="predefined-type">String</span> name = eq.getProperty();
        validateProperty(entity, name, Equals.class);

        q.append(calculateName(entity, name));
        <span class="keyword">return</span> appendOrEmbedValue(q, params, index, eq.getValue(), EQUALS);
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case a <code>StringBuilder</code> is used to construct a OQL query from the <code>Query</code> model.</p>
</div>
</div>
<div class="sect2">
<h3 id="gormEnhancer">GORM Enhancer</h3>
<div class="paragraph">
<p>Once you have implemented the lower-level APIs you can trivially provide a GORM API to a set of Grails domain classes. For example consider the following simple domain class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.persistence.*</span>

<span class="annotation">@Entity</span>
<span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> title
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following setup code can be written to enable GORM for MongoDB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// create context</span>
<span class="keyword">def</span> context = <span class="keyword">new</span> MongoMappingContext(databaseName)
context.addPersistentEntity(<span class="predefined-type">Book</span>)

<span class="comment">// create datastore</span>
<span class="keyword">def</span> mongoDatastore = <span class="keyword">new</span> MongoDatastore(context)
mongoDatastore.afterPropertiesSet()

<span class="comment">// enhance</span>
<span class="keyword">def</span> enhancer = <span class="keyword">new</span> MongoGormEnhancer(mongoDatastore, <span class="keyword">new</span> DatastoreTransactionManager(<span class="key">datastore</span>: mongoDatastore))
enhancer.enhance()

<span class="comment">// use GORM!</span>
<span class="keyword">def</span> books = <span class="predefined-type">Book</span>.list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>They key part to enabling the usage of all the GORM methods (<code>list()</code>, dynamic finders etc.) is the usage of the <code>MongoGormEnhancer</code>. This class subclasses <code>org.grails.datastore.gorm.GormEnhancer</code> and provides some extensions to GORM specific to MongoDB. A subclass is not required however and if you don&#8217;t require any datastore specific extensions you can just as easily use the regular <code>GormEnhancer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> enhancer = <span class="keyword">new</span> GormEnhancer(mongoDatastore, <span class="keyword">new</span> DatastoreTransactionManager(<span class="key">datastore</span>: mongoDatastore))
enhancer.enhance()</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gormApis">Adding to GORM APIs</h3>
<div class="paragraph">
<p>By default the GORM compiler will make all GORM entities implement the <code>GormEntity</code> trait. Which provide all of the default GORM methods. However if you want to extend GORM to provide more methods specific to a given data store you can do so by extending this trait.</p>
</div>
<div class="paragraph">
<p>For example Neo4j adds methods for Cypher querying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">trait Neo4jEntity&lt;D&gt; <span class="directive">extends</span> GormEntity&lt;D&gt; {

    <span class="directive">static</span> <span class="predefined-type">Result</span> cypherStatic(<span class="predefined-type">String</span> queryString, <span class="predefined-type">Map</span> params ) {
        <span class="keyword">def</span> session = AbstractDatastore.retrieveSession(Neo4jDatastore)
        <span class="keyword">def</span> graphDatabaseService = (GraphDatabaseService)session.nativeInterface
        graphDatabaseService.execute(queryString, params)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this addition then you then need to tell the GORM compiler to make entities implement this trait. To do that implement a <code>TraitProvider</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> org.grails.datastore.gorm.neo4j

<span class="keyword">import</span> <span class="include">grails.neo4j.Neo4jEntity</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.grails.compiler.gorm.GormEntityTraitProvider</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Neo4jEntityTraitProvider</span> <span class="directive">implements</span> GormEntityTraitProvider {
    <span class="directive">final</span> <span class="predefined-type">Class</span> entityTrait = Neo4jEntity
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then add a <code>src/main/resources/META-INF/services/org.grails.compiler.gorm.GormEntityTraitProvider</code> file specifying the name of your trait provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">org.grails.datastore.gorm.neo4j.Neo4jEntityTraitProvider</code></pre>
</div>
</div>
<div class="paragraph">
<p>GORM will automatically inject to trait into any domain class found in <code>grails-app/domain</code> or annotated with the <code>Entity</code> annotation, unless Hibernate is on the classpath in which case you have to tell GORM to map the domain class with Neo4j:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">static</span> mapWith = <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">Using the Test Compatibility Kit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>grails-datastore-gorm-tck</code> project provides a few hundred tests that ensure a particular GORM implementation is compliant. To use the TCK you need to define a dependency on the TCK in the subprojects <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">testCompile project(<span class="string"><span class="delimiter">'</span><span class="content">:grails-datastore-gorm-tck</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create a <code>Setup.groovy</code> file that sets up your custom datastore in your implementation.</p>
</div>
<div class="paragraph">
<p>For example the <code>ConcurrentHashMap</code> implementation has one defined in <code>grails-datastore-gorm-test/src/test/groovy/org/grails/datastore/gorm/Setup.groovy</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Setup</span> {

    <span class="directive">static</span> destroy() {
        <span class="comment">// noop</span>
    }
    <span class="directive">static</span> Session setup(classes) {

        <span class="keyword">def</span> ctx = <span class="keyword">new</span> GenericApplicationContext()
        ctx.refresh()
        <span class="keyword">def</span> simple = <span class="keyword">new</span> SimpleMapDatastore(ctx)

        ...
        for (cls <span class="keyword">in</span> classes) {
            simple.mappingContext.addPersistentEntity(cls)
        }

        ...
        def enhancer = <span class="keyword">new</span> GormEnhancer(simple, <span class="keyword">new</span> DatastoreTransactionManager(<span class="key">datastore</span>: simple))
        enhancer.enhance()

        simple.mappingContext.addMappingContextListener({ e -&gt; enhancer.enhance e } <span class="keyword">as</span> MappingContext.Listener)

        simple.applicationContext.addApplicationListener <span class="keyword">new</span> DomainEventListener(simple)
        simple.applicationContext.addApplicationListener <span class="keyword">new</span> AutoTimestampEventListener(simple)

        <span class="keyword">return</span> simple.connect()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some setup code has been omitted for clarity but basically the <code>Setup.groovy</code> class should initiase the <code>Datastore</code> and return a <code>Session</code> from the static <code>setup</code> method which gets passed a list of classes that need to be configured.</p>
</div>
<div class="paragraph">
<p>With this done all of the TCK tests will run against the subproject. If a particular test cannot be implemented because the underlying datastore doesn&#8217;t support the feature then you can create a test that matches the name of the test that is failing and it will override said test.</p>
</div>
<div class="paragraph">
<p>For example SimpleDB doesn&#8217;t support pagination so there is a <code>grails.gorm.tests.PagedResultSpec</code> class that overrides the one from the TCK. Each test is a Spock specification and Spock has an <code>Ignore</code> annotation that can be used to ignore a particular test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">/**
 * Ignored for SimpleDB because SimpleDB doesn't support pagination
 */</span>
<span class="annotation">@Ignore</span>
<span class="type">class</span> <span class="class">PagedResultSpec</span> <span class="directive">extends</span> GormDatastoreSpec{
   ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stepByStep">Step by Step Guide to Creating an Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get started with your a new GORM implementation the following steps are required:</p>
</div>
<div class="sect2">
<h3 id="_initial_directory_creation">Initial Directory Creation</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="error">$</span> git clone git<span class="annotation">@github</span>.com:grails/grails-data-mapping.git
<span class="error">$</span> cd grails-data-mapping
<span class="error">$</span> mkdir grails-datastore-gorm-xyz</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setup_gradle_build">Setup Gradle Build</h3>
<div class="paragraph">
<p>Create build.gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="error">$</span> vi grails-datastore-gorm-xyz/build.gradle</code></pre>
</div>
</div>
<div class="paragraph">
<p>With contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    compile project(<span class="string"><span class="delimiter">'</span><span class="content">:grails-datastore-gorm</span><span class="delimiter">'</span></span>),
            project(<span class="string"><span class="delimiter">'</span><span class="content">:grails-datastore-web</span><span class="delimiter">'</span></span>),
            project(<span class="string"><span class="delimiter">'</span><span class="content">:grails-datastore-gorm-support</span><span class="delimiter">'</span></span>)

    testCompile project(<span class="string"><span class="delimiter">'</span><span class="content">:grails-datastore-gorm-tck</span><span class="delimiter">'</span></span>)
    testRuntime <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.servlet:javax.servlet-api:</span><span class="inline"><span class="inline-delimiter">$</span>servletApiVersion</span><span class="delimiter">&quot;</span></span>

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add new project to settings.gradle in root project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="error">$</span> vi settings.gradle</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changes shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// GORM Implementations</span>
<span class="string"><span class="delimiter">'</span><span class="content">grails-datastore-gorm-neo4j</span><span class="delimiter">'</span></span>,
<span class="string"><span class="delimiter">'</span><span class="content">grails-datastore-gorm-xyz</span><span class="delimiter">'</span></span>,
....</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_project_source_directories">Create Project Source Directories</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="error">$</span> mkdir grails-datastore-gorm-xyz/src/main/groovy
<span class="error">$</span> mkdir grails-datastore-gorm-xyz/src/test/groovy</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generate_ide_project_files_and_import_into_ide">Generate IDE Project Files and Import into IDE</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="error">$</span> gradlew grails-datastore-gorm-<span class="key">xyz</span>:idea</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="error">$</span> gradlew grails-datastore-gorm-<span class="key">xyz</span>:eclipse</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implement_required_interfaces">Implement Required Interfaces</h3>
<div class="paragraph">
<p>In <code>src/main/groovy</code> create implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.grails.datastore.xyz.XyzDatastore</code> extends and implements <code>org.grails.datastore.mapping.core.AbstractDatastore</code></p>
</li>
<li>
<p><code>org.grails.datastore.xyz.XyzSession</code> extends and implements <code>org.grails.datastore.mapping.core.AbstractSession</code></p>
</li>
<li>
<p><code>org.grails.datastore.xyz.engine.XyzEntityPersister</code> extends and implements <code>org.grails.datastore.mapping.engine.NativeEntryEntityPersister</code></p>
</li>
<li>
<p><code>org.grails.datastore.xyz.query.XyzQuery</code> extends and implements <code>org.grails.datastore.mapping.query.Query</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_create_test_suite">Create Test Suite</h3>
<div class="paragraph">
<p>In <code>src/test/groovy</code> create <code>org.grails.datastore.gorm.Setup</code> class to configure TCK:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Setup</span> {

    <span class="directive">static</span> xyz
    <span class="directive">static</span> destroy() {
        xyz.disconnect()
    }
    <span class="directive">static</span> Session setup(classes) {
        <span class="keyword">def</span> ctx = <span class="keyword">new</span> GenericApplicationContext()
        ctx.refresh()
        xyz = <span class="keyword">new</span> XyzDatastore(ctx)
        <span class="keyword">for</span> (cls <span class="keyword">in</span> classes) {
            xyz.mappingContext.addPersistentEntity(cls)
        }


        <span class="keyword">def</span> enhancer = <span class="keyword">new</span> GormEnhancer(xyz, <span class="keyword">new</span> DatastoreTransactionManager(<span class="key">datastore</span>: xyz))
        enhancer.enhance()

        xyz.mappingContext.addMappingContextListener({ e -&gt; enhancer.enhance e } <span class="keyword">as</span> MappingContext.Listener)
        xyz.applicationContext.addApplicationListener <span class="keyword">new</span> DomainEventListener(xyz)
        xyz.applicationContext.addApplicationListener <span class="keyword">new</span> AutoTimestampEventListener(xyz)

        xyz.connect()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in <code>src/test/groovy</code> create test suite class to allow running tests in IDE (without this you won&#8217;t be able to run TCK tests from the IDE). Example test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> org.grails.datastore.gorm

<span class="keyword">import</span> <span class="include">org.junit.runners.Suite.SuiteClasses</span>
<span class="keyword">import</span> <span class="include">org.junit.runners.Suite</span>
<span class="keyword">import</span> <span class="include">org.junit.runner.RunWith</span>
<span class="keyword">import</span> <span class="include">grails.gorm.tests.*</span>

<span class="comment">/**
 * @author graemerocher
 */</span>
<span class="annotation">@RunWith</span>(Suite)
<span class="annotation">@SuiteClasses</span>([
  FindByMethodSpec,
  ListOrderBySpec
])
<span class="type">class</span> <span class="class">XyzTestSuite</span> {
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implement_the_tck">Implement the TCK!</h3>
<div class="paragraph">
<p>Keep iterating until you have implemented all the tests in the TCK.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>